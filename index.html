<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Symptomatic ‚Äî Symptom Tracker</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
      --muted2: rgba(255,255,255,0.52);
      --brand: #7c5cff;
      --brand2:#35d2ff;
      --good:#25d366;
      --warn:#ffb020;
      --bad:#ff4d6d;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 24px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(124,92,255,0.22), transparent 55%),
        radial-gradient(900px 700px at 80% 30%, rgba(53,210,255,0.18), transparent 60%),
        radial-gradient(900px 700px at 50% 105%, rgba(255,77,109,0.10), transparent 60%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    a{ color: var(--brand2); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{ max-width: 1120px; margin: 0 auto; padding: 22px 16px 70px; }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
    }
    .logo{
      width:44px;height:44px;border-radius:16px;
      background:
        radial-gradient(16px 16px at 25% 25%, rgba(255,255,255,0.85), transparent 55%),
        linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 18px 40px rgba(124,92,255,.18);
    }
    .brand h1{ font-size: 16px; margin:0; letter-spacing:.2px; }
    .brand p{ margin:2px 0 0; color: var(--muted); font-size: 12px; line-height:1.35; }

    .nav{ display:flex; gap:8px; flex-wrap: wrap; justify-content:flex-end; }
    .tab{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 13px;
      display:flex;
      align-items:center;
      gap:8px;
      transition: .18s ease;
      user-select:none;
    }
    .tab:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,0.18); background: rgba(255,255,255,0.06); }
    .tab.active{
      background: linear-gradient(135deg, rgba(124,92,255,0.28), rgba(53,210,255,0.18));
      border-color: rgba(255,255,255,0.20);
      box-shadow: 0 16px 40px rgba(0,0,0,0.22);
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } .brand{ min-width:auto; } }

    .card{
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.03));
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 15px;
    }
    .card h2{ margin: 0 0 10px; font-size: 14px; letter-spacing:.2px; }
    .sub{
      color: var(--muted);
      font-size: 12px;
      margin-top:-6px;
      margin-bottom: 10px;
      line-height: 1.45;
    }

    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
      flex: 1 1 170px;
      min-width: 170px;
    }
    label{ font-size: 12px; color: var(--muted); }

    input, textarea, select{
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      font-size: 13px;
      transition: .15s ease;
    }
    textarea{ min-height: 78px; resize: vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(53,210,255,0.32);
      box-shadow: 0 0 0 4px rgba(53,210,255,0.08);
    }

    .split{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .divider{ height:1px; background: rgba(255,255,255,0.08); margin: 12px 0; }

    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    /* Buttons */
    .btn{
      background: linear-gradient(135deg, rgba(124,92,255,0.90), rgba(53,210,255,0.70));
      border: 0;
      color: white;
      font-weight: 650;
      padding: 11px 14px;
      border-radius: 14px;
      cursor:pointer;
      transition: .18s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
      position: relative;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.04); }
    .btn.secondary{
      background: rgba(255,255,255,0.07);
      border: 1px solid var(--stroke);
      color: var(--text);
      font-weight: 600;
    }
    .btn.ghost{
      background: transparent;
      border: 1px solid var(--stroke);
      color: var(--text);
      font-weight: 600;
    }
    .btn.danger{
      background: rgba(255,77,109,0.14);
      border: 1px solid rgba(255,77,109,0.35);
      color: rgba(255,255,255,0.92);
    }
    .btn.small{ padding: 8px 10px; border-radius: 12px; font-size: 12px; }
    .btn[disabled]{ opacity:0.65; cursor:not-allowed; transform:none !important; }

    /* Loading state */
    .btn.loading{
      pointer-events:none;
      opacity:0.9;
    }
    .btn.loading::after{
      content:"";
      width: 14px; height:14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.45);
      border-top-color: rgba(255,255,255,0.95);
      display:inline-block;
      margin-left: 2px;
      animation: spin .8s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    /* ‚Äúunloaded‚Äù buttons (skeleton) */
    .ghost-skeleton{
      border-radius: 14px;
      padding: 11px 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.035);
      color: rgba(255,255,255,0.40);
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
      position: relative;
      overflow:hidden;
    }
    .ghost-skeleton::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
      transform: translateX(-100%);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{
      100%{ transform: translateX(100%); }
    }

    /* Lists */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .item .top{ display:flex; align-items:flex-start; justify-content:space-between; gap: 12px; }
    .item h3{ margin:0; font-size: 13px; letter-spacing:.2px; }
    .meta{ color: var(--muted); font-size: 12px; margin-top: 3px; line-height: 1.35; }
    .tiny-disclaimer{
      margin-top: 10px;
      font-size: 11px;
      color: rgba(255,255,255,0.55);
      border-top: 1px dashed rgba(255,255,255,0.14);
      padding-top: 8px;
    }

    /* Chips */
    .chipbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.82);
      cursor:pointer;
      font-size: 12px;
      transition: .14s ease;
      user-select:none;
      position: relative;
    }
    .chip:hover{
      transform: translateY(-1px);
      border-color: rgba(53,210,255,0.28);
      background: rgba(53,210,255,0.06);
    }
    .chip.active{
      border-color: rgba(53,210,255,0.38);
      background: rgba(53,210,255,0.10);
      box-shadow: 0 10px 30px rgba(0,0,0,0.22);
    }

    /* Disorders grid */
    .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 980px){ .cards{ grid-template-columns: 1fr; } }
    .dcard{
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background:
        radial-gradient(500px 200px at 10% 10%, rgba(124,92,255,0.12), transparent 55%),
        rgba(255,255,255,0.04);
      cursor:pointer;
      transition: .18s ease;
      min-height: 92px;
    }
    .dcard:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,0.18);
      box-shadow: 0 24px 60px rgba(0,0,0,0.32);
    }
    .dcard h3{ margin:0 0 6px; font-size: 13px; }
    .dcard p{ margin:0; color: var(--muted); font-size: 12px; line-height: 1.4; }

    /* Modal */
    .modalBack{
      position: fixed; inset:0;
      background: rgba(0,0,0,0.6);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(980px, 100%);
      max-height: 88vh;
      overflow:auto;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.16);
      background:
        radial-gradient(900px 400px at 20% 10%, rgba(53,210,255,0.10), transparent 60%),
        radial-gradient(900px 400px at 85% 20%, rgba(124,92,255,0.16), transparent 60%),
        rgba(11,18,32,0.92);
      box-shadow: 0 40px 90px rgba(0,0,0,0.58);
      padding: 16px;
    }
    .modalHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .modalHeader h2{ margin:0; font-size: 16px; }
    .close{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
    }

    .cols{ display:grid; grid-template-columns: 1.2fr 0.8fr; gap: 14px; }
    @media (max-width: 980px){ .cols{ grid-template-columns: 1fr; } }

    .kvs{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 6px; }
    .kv{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.78);
    }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    footer{
      margin-top: 14px;
      color: rgba(255,255,255,0.55);
      font-size: 12px;
      line-height: 1.45;
    }

    .softTitle{ font-size: 12px; color: rgba(255,255,255,0.80); margin: 0 0 6px; letter-spacing:.2px; }
    .helpBox{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.86);
      font-size: 12px;
      line-height: 1.55;
    }

    .lockRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .lockedBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.72);
    }
    .premiumCard{
      border: 1px solid rgba(124,92,255,0.22);
      background:
        radial-gradient(500px 200px at 10% 10%, rgba(124,92,255,0.10), transparent 55%),
        rgba(255,255,255,0.04);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Symptomatic</h1>
          <p>A clean, private symptom tracker with gentle insights. <span style="color:var(--muted2)">Educational only.</span></p>
        </div>
      </div>

      <div class="nav">
        <button class="tab active" data-view="logView">üìù Log</button>
        <button class="tab" data-view="libraryView">üìö Library</button>
        <button class="tab" data-view="disordersView">üß† Conditions</button>
        <button class="tab" data-view="insightsView">üìà Trends</button>
      </div>
    </div>

    <!-- LOG VIEW -->
    <div id="logView" class="view active">
      <div class="grid">
        <div class="card">
          <div class="split">
            <div>
              <h2>How are you feeling today?</h2>
              <div class="sub">Log a quick entry. You‚Äôll get a few <b>possible matches</b> + <b>comfort suggestions</b>.</div>
            </div>
            <span class="pill">Saved locally</span>
          </div>

          <form id="symptomForm">
            <div class="row">
              <div class="field">
                <label for="symptomName">Symptom</label>
                <input id="symptomName" placeholder="e.g., sore throat, headache, nausea" autocomplete="off"/>
              </div>

              <div class="field">
                <label for="severity">Severity</label>
                <select id="severity">
                  <option value="1">1 (very mild)</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5" selected>5 (moderate)</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10 (severe)</option>
                </select>
              </div>

              <div class="field">
                <label for="duration">Duration</label>
                <input id="duration" placeholder="e.g., 2 hours, since yesterday" autocomplete="off"/>
              </div>
            </div>

            <div class="divider"></div>

            <!-- NEW: What happened before -->
            <div>
              <div class="softTitle">What happened before this started?</div>
              <div class="sub" style="margin-top:0">Tap anything that applies ‚Äî it helps you spot patterns later.</div>
              <div class="chipbar" id="triggerChips"></div>

              <div class="row" style="margin-top:10px;">
                <div class="field" style="flex:1 1 100%;">
                  <label for="notes">Notes (optional)</label>
                  <textarea id="notes" placeholder="Anything else? (meds you took, what helped, other symptoms...)"></textarea>
                </div>
              </div>
            </div>

            <div class="row" style="margin-top:12px; justify-content:space-between;">
              <div class="row" style="gap:10px;">
                <button type="submit" class="btn" id="saveBtn">üíæ Save</button>
                <button type="button" id="quickFromLibrary" class="btn secondary">‚ûï Pick from library</button>

                <!-- intentionally ‚Äúunloaded‚Äù looking buttons -->
                <div class="ghost-skeleton">‚ú® Smart mode</div>
                <div class="ghost-skeleton">üßæ Export</div>
              </div>

              <button type="button" id="clearAll" class="btn danger">üóëÔ∏è Clear all</button>
            </div>
          </form>

          <div class="divider"></div>

          <div class="split">
            <div>
              <h2 style="margin-bottom:6px;">Your history</h2>
              <div class="sub">Newest first. Click buttons to copy or delete.</div>
            </div>
            <div class="row">
              <span class="pill" id="countPill">0 entries</span>
            </div>
          </div>

          <div id="historyList" class="list"></div>
        </div>

        <!-- Suggestions -->
        <div class="card">
          <div class="split">
            <div>
              <h2>Helpful suggestions</h2>
              <div class="sub">Based on your recent entries. Keep it simple ‚Äî and trust your gut.</div>
            </div>
            <button id="refreshAi" class="btn ghost">üîÑ Refresh</button>
          </div>

          <div id="aiList" class="list"></div>

          <footer>
            <b>Small note:</b> This app is educational and not medical advice. If symptoms are severe, sudden, or worrying ‚Äî get professional care.
          </footer>
        </div>
      </div>

      <!-- Premium Photo Insights -->
      <div class="card premiumCard" style="margin-top:14px;">
        <div class="split">
          <div>
            <h2>Photo insights</h2>
            <div class="sub">Upload a photo (like a rash, bruise, swelling) for pattern-based info. <span style="color:var(--muted2)">Not a diagnosis.</span></div>
          </div>
          <span class="pill" id="premiumPill">üîí Premium locked</span>
        </div>

        <div id="premiumLocked" class="helpBox">
          <div class="lockRow">
            <span class="lockedBadge">üîí Unlock for $5</span>
            <button class="btn small" id="unlockPremiumBtn">Unlock</button>
          </div>
          <div class="tiny-disclaimer">
            This unlock is a local demo (no real payment is processed here). This is not real medical advice.
          </div>
        </div>

        <div id="premiumUnlocked" style="display:none;">
          <div class="row" style="align-items:flex-end;">
            <div class="field" style="flex:1 1 320px;">
              <label for="photoInput">Add photo</label>
              <input type="file" id="photoInput" accept="image/*" />
            </div>
            <button class="btn secondary" id="analyzePhotoBtn">üîç Check photo</button>
          </div>

          <div class="divider"></div>

          <div class="item" id="photoResult">
            <h3>üì∑ Photo notes</h3>
            <div class="meta">Upload an image to see general pattern-based possibilities.</div>
            <div class="tiny-disclaimer">This is not real medical advice.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- LIBRARY VIEW -->
    <div id="libraryView" class="view">
      <div class="grid">
        <div class="card">
          <div class="split">
            <div>
              <h2>Symptom library</h2>
              <div class="sub">Search common symptoms and add them quickly.</div>
            </div>
            <span class="pill">Tip: type ‚Äúfev‚Äù ‚Üí fever</span>
          </div>

          <div class="row" style="margin-top:8px;">
            <div class="field" style="flex:1 1 100%;">
              <label for="librarySearch">Search</label>
              <input id="librarySearch" placeholder="Start typing..." autocomplete="off"/>
            </div>
          </div>

          <div class="chipbar" id="libraryChips"></div>

          <div class="divider"></div>

          <div class="helpBox">
            <b>Quick flow:</b> click a symptom ‚Üí choose severity + duration ‚Üí save.
            <div class="tiny-disclaimer">This is not real medical advice.</div>
          </div>
        </div>

        <div class="card">
          <h2>Quick add</h2>
          <div class="sub">Pick a symptom on the left to fill this panel.</div>
          <div id="libraryAddPanel" class="item">
            <div class="meta">Select a symptom to begin.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DISORDERS VIEW -->
    <div id="disordersView" class="view">
      <div class="card">
        <div class="split">
          <div>
            <h2>Common conditions</h2>
            <div class="sub">Click a condition to see what it usually looks like and what people commonly do.</div>
          </div>
          <div class="row">
            <div class="field" style="min-width:260px; flex:0 1 320px;">
              <label for="disorderSearch">Search</label>
              <input id="disorderSearch" placeholder="e.g., migraine, GERD, UTI" autocomplete="off"/>
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <div id="disorderCards" class="cards"></div>
      </div>
    </div>

    <!-- INSIGHTS VIEW -->
    <div id="insightsView" class="view">
      <div class="grid">
        <div class="card">
          <div class="split">
            <div>
              <h2>Severity over time</h2>
              <div class="sub">A quick view to spot patterns.</div>
            </div>
            <button id="rebuildCharts" class="btn ghost">üîÅ Rebuild</button>
          </div>
          <div class="item">
            <canvas id="severityChart" height="110"></canvas>
            <div class="tiny-disclaimer">This is not real medical advice.</div>
          </div>

          <div class="divider"></div>

          <div class="helpBox">
            <b>Tip:</b> if you see spikes, check what happened before them (sleep, stress, being around sick people, foods, workouts).
            <div class="tiny-disclaimer">This is not real medical advice.</div>
          </div>
        </div>

        <div class="card">
          <h2>What usually helps (informational)</h2>
          <div class="sub">Pick a condition to see general options people commonly try.</div>
          <div class="item">
            <div class="split">
              <span class="pill" id="selectedDisorderPill">No condition selected</span>
              <button id="pickDisorderFromInsights" class="btn secondary">üß† Pick</button>
            </div>
            <div style="margin-top:12px;">
              <canvas id="effectivenessChart" height="130"></canvas>
            </div>
            <div class="tiny-disclaimer">Ratings vary by person. This is not real medical advice.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for disorders -->
    <div id="modalBack" class="modalBack">
      <div class="modal">
        <div class="modalHeader">
          <div>
            <h2 id="modalTitle">Condition</h2>
            <div class="kvs" id="modalTags"></div>
          </div>
          <button class="close" id="closeModal">‚úï</button>
        </div>

        <div class="cols">
          <div>
            <div class="item">
              <h3 style="margin:0 0 6px;">Overview</h3>
              <div class="meta" id="modalOverview"></div>
            </div>

            <div class="item" style="margin-top:12px;">
              <h3 style="margin:0 0 6px;">Common symptoms</h3>
              <div class="meta" id="modalSymptoms"></div>
            </div>

            <div class="item" style="margin-top:12px;">
              <h3 style="margin:0 0 6px;">What people usually do (general)</h3>
              <ul id="modalTreatments" style="margin:10px 0 0; padding-left: 18px; color: rgba(255,255,255,0.86); font-size: 13px; line-height: 1.5;"></ul>
              <div class="tiny-disclaimer">This is not real medical advice.</div>
            </div>
          </div>

          <div>
            <div class="item">
              <h3 style="margin:0 0 6px;">Trusted sources</h3>
              <div class="meta" id="modalSources"></div>
            </div>

            <div class="item" style="margin-top:12px;">
              <h3 style="margin:0 0 6px;">Effectiveness chart (informational)</h3>
              <div class="meta" style="margin-bottom:10px;">Approximate ratings. Varies widely.</div>
              <canvas id="modalEffectivenessChart" height="180"></canvas>
              <div class="tiny-disclaimer">This is not real medical advice.</div>
            </div>

            <div class="item" style="margin-top:12px;">
              <h3 style="margin:0 0 6px;">Quick add a related symptom</h3>
              <div class="meta" id="modalQuickAdd"></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="helpBox">
          <b>Reminder:</b> These are informational patterns ‚Äî not a diagnosis. If anything feels severe or ‚Äúoff,‚Äù get care.
          <div class="tiny-disclaimer">This is not real medical advice.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**************************************************
     * Storage
     **************************************************/
    const STORAGE_KEY = "symptomatic_history_v3";
    const SETTINGS_KEY = "symptomatic_settings_v2";
    const UI_KEY = "symptomatic_ui_v2";
    const PREMIUM_KEY = "symptomatic_premium_v1";

    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }catch{ return []; }
    }
    function saveHistory(h){ localStorage.setItem(STORAGE_KEY, JSON.stringify(h)); }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function normalizeText(s){ return String(s || "").toLowerCase().trim(); }
    function prettyTime(iso){
      const d = new Date(iso);
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /**************************************************
     * Trigger chips (NEW)
     **************************************************/
    const triggerOptions = [
      "ü•∂ Was out in the cold",
      "ü§ß Near someone coughing / sick",
      "üò¥ Slept poorly",
      "üòì Stress / anxiety day",
      "üçî Ate something unusual",
      "üèãÔ∏è Worked out harder than usual",
      "‚úàÔ∏è Traveled recently",
      "ü•§ Maybe dehydrated",
      "üåø Allergens / dust / pets",
      "üßº New soap / skincare / detergent",
      "ü§ï Minor injury / strain",
      "‚ùì Not sure"
    ];

    const triggerChipsEl = document.getElementById("triggerChips");
    let selectedTriggers = new Set();

    function renderTriggerChips(){
      triggerChipsEl.innerHTML = "";
      triggerOptions.forEach(t => {
        const el = document.createElement("div");
        el.className = "chip" + (selectedTriggers.has(t) ? " active" : "");
        el.textContent = t;
        el.addEventListener("click", () => {
          if (selectedTriggers.has(t)) selectedTriggers.delete(t);
          else selectedTriggers.add(t);
          renderTriggerChips();
        });
        triggerChipsEl.appendChild(el);
      });
    }

    /**************************************************
     * Symptom library (~100+)
     **************************************************/
    const symptomLibrary = [
      "Abdominal pain","Acid reflux/heartburn","Anxiety","Back pain","Bloating","Blood in stool",
      "Body aches","Bruising easily","Burning urination","Chest tightness","Chills","Congestion",
      "Constipation","Cough","Cramps","Decreased appetite","Dehydration signs","Diarrhea",
      "Difficulty breathing","Difficulty swallowing","Dizziness","Dry eyes","Dry mouth","Dry skin",
      "Ear pain","Ear ringing (tinnitus)","Excessive thirst","Eye pain","Eye redness","Fainting",
      "Fatigue","Fever","Frequent urination","Gas","Headache","Heart palpitations","Hoarseness",
      "Hot flashes","Itchy eyes","Itchy skin","Joint pain","Leg swelling","Light sensitivity",
      "Loss of smell","Loss of taste","Low energy","Lower back pain","Menstrual cramps","Mood swings",
      "Muscle cramps","Muscle weakness","Nasal drip","Nausea","Neck pain","Numbness/tingling",
      "Painful swallowing","Panic feelings","Post-nasal drip","Rash","Runny nose","Shortness of breath",
      "Sinus pressure","Sleep problems/insomnia","Sneezing","Sore throat","Stomach cramps",
      "Sweating (excess)","Swollen glands","Swollen joints","Tremor","Trouble concentrating",
      "Unexplained weight change","Vomiting","Wheezing","Blurred vision","Watery eyes",
      "Indigestion","Pelvic pain","Hives","Skin peeling","Mouth sores","Bleeding gums","Toothache",
      "Nosebleed","Dark urine","Hair shedding","Brittle nails","Swollen ankles","Hand pain",
      "Wrist pain","Hip pain","Foot pain","Burning sensation","Pins and needles","Night sweats",
      "Snoring","Daytime sleepiness"
    ];

    /**************************************************
     * Common conditions (unchanged in spirit)
     **************************************************/
    const disorders = [
      {
        id:"common-cold", name:"Common cold", tags:["Respiratory","Viral"],
        overview:"A viral upper respiratory infection that often causes congestion, sore throat, and cough. Most cases improve with time and supportive care.",
        symptoms:["Runny nose","Congestion","Sore throat","Cough","Sneezing","Mild fever","Fatigue"],
        treatments:[
          { label:"Rest + hydration", score:5, note:"Supportive care helps recovery." },
          { label:"Saline nasal rinse/spray", score:4, note:"Can ease congestion." },
          { label:"Honey (for cough, age-appropriate)", score:4, note:"May soothe cough." },
          { label:"OTC pain/fever reducers (if safe for you)", score:3, note:"Helps comfort; not a cure." },
          { label:"Humidifier/steam", score:3, note:"May reduce irritation." }
        ],
        sources:[
          { name:"CDC (Common cold)", url:"https://www.cdc.gov/antibiotic-use/colds.html" },
          { name:"NHS (Common cold)", url:"https://www.nhs.uk/conditions/common-cold/" }
        ]
      },
      {
        id:"influenza", name:"Influenza (flu)", tags:["Respiratory","Viral"],
        overview:"A contagious respiratory illness that can cause fever, body aches, and fatigue. Some people are at higher risk for complications.",
        symptoms:["Fever","Chills","Body aches","Cough","Sore throat","Fatigue","Headache"],
        treatments:[
          { label:"Rest + fluids", score:4, note:"Key for recovery." },
          { label:"OTC fever/pain relief (if safe)", score:3, note:"Comfort measures." },
          { label:"Seek care early if high-risk", score:5, note:"Antivirals may help some people when started early." },
          { label:"Isolation to reduce spread", score:5, note:"Protects others." }
        ],
        sources:[
          { name:"CDC (Flu)", url:"https://www.cdc.gov/flu/" },
          { name:"MedlinePlus (Flu)", url:"https://medlineplus.gov/flu.html" }
        ]
      },
      {
        id:"allergic-rhinitis", name:"Seasonal allergies", tags:["Allergy","ENT"],
        overview:"An allergic response that can cause sneezing, itchy eyes, and runny nose, often triggered by pollen, dust, or pets.",
        symptoms:["Sneezing","Runny nose","Itchy eyes","Watery eyes","Congestion","Post-nasal drip"],
        treatments:[
          { label:"Avoid triggers (when possible)", score:4, note:"Reduces exposure." },
          { label:"Saline rinse", score:3, note:"Helps wash out allergens." },
          { label:"OTC antihistamines (if safe)", score:4, note:"Often helpful for itch/sneeze." },
          { label:"Nasal steroid spray (if appropriate)", score:5, note:"Commonly effective for congestion." }
        ],
        sources:[
          { name:"NHS (Hay fever)", url:"https://www.nhs.uk/conditions/hay-fever/" },
          { name:"Mayo Clinic (Allergic rhinitis)", url:"https://www.mayoclinic.org/diseases-conditions/hay-fever/symptoms-causes/syc-20373039" }
        ]
      },
      {
        id:"migraine", name:"Migraine", tags:["Neurology","Headache"],
        overview:"A type of headache that can be intense and may come with nausea, sensitivity to light/sound, and sometimes aura.",
        symptoms:["Headache","Nausea","Light sensitivity","Sound sensitivity","Vision changes (aura)"],
        treatments:[
          { label:"Hydration + rest in a dark room", score:4, note:"Often helps symptom control." },
          { label:"Identify triggers (sleep, stress, foods)", score:4, note:"Helps prevent future attacks." },
          { label:"OTC pain relief (if safe)", score:3, note:"May help mild/moderate migraines." },
          { label:"Prescription options (clinician-guided)", score:5, note:"Some meds are migraine-specific." }
        ],
        sources:[
          { name:"NIH MedlinePlus (Migraine)", url:"https://medlineplus.gov/migraine.html" },
          { name:"Mayo Clinic (Migraine)", url:"https://www.mayoclinic.org/diseases-conditions/migraine-headache/symptoms-causes/syc-20360201" }
        ]
      },
      {
        id:"gerd", name:"GERD (acid reflux)", tags:["Digestive"],
        overview:"A condition where stomach acid flows back into the esophagus, causing heartburn and irritation.",
        symptoms:["Heartburn","Acid reflux/heartburn","Chest discomfort","Sour taste","Worse after meals"],
        treatments:[
          { label:"Avoid trigger foods (spicy/fatty, caffeine)", score:4, note:"Commonly reduces symptoms." },
          { label:"Smaller meals + avoid late eating", score:4, note:"Helps reflux control." },
          { label:"Elevate head of bed", score:3, note:"Can reduce nighttime symptoms." },
          { label:"OTC antacids (if safe)", score:3, note:"Short-term relief for some." },
          { label:"Talk to a clinician if frequent", score:5, note:"Persistent symptoms warrant evaluation." }
        ],
        sources:[
          { name:"NHS (Acid reflux)", url:"https://www.nhs.uk/conditions/heartburn-and-acid-reflux/" },
          { name:"Mayo Clinic (GERD)", url:"https://www.mayoclinic.org/diseases-conditions/gerd/symptoms-causes/syc-20361940" }
        ]
      },
      {
        id:"uti", name:"Urinary tract infection (UTI)", tags:["Urinary"],
        overview:"An infection in the urinary system that can cause burning urination and frequent urges. Some cases need medical treatment.",
        symptoms:["Burning urination","Frequent urination","Lower abdominal pain","Cloudy urine"],
        treatments:[
          { label:"Hydration", score:3, note:"May help comfort; does not replace treatment if needed." },
          { label:"Seek testing/treatment (often antibiotics)", score:5, note:"Important to prevent complications." },
          { label:"Avoid irritants (caffeine/alcohol)", score:3, note:"May reduce bladder irritation." }
        ],
        sources:[
          { name:"MedlinePlus (UTI)", url:"https://medlineplus.gov/urinarytractinfections.html" },
          { name:"NHS (UTI)", url:"https://www.nhs.uk/conditions/urinary-tract-infections-utis/" }
        ]
      },
      {
        id:"gastroenteritis", name:"Stomach bug (gastroenteritis)", tags:["Digestive","Viral/Bacterial"],
        overview:"Inflammation of the stomach and intestines that often causes diarrhea, vomiting, cramps, and dehydration risk.",
        symptoms:["Diarrhea","Vomiting","Nausea","Stomach cramps","Fever","Dehydration signs"],
        treatments:[
          { label:"Oral rehydration (fluids/electrolytes)", score:5, note:"Key to prevent dehydration." },
          { label:"Rest + bland foods when tolerated", score:4, note:"Supports recovery." },
          { label:"Seek care if severe dehydration/blood", score:5, note:"Red flags need attention." }
        ],
        sources:[
          { name:"CDC (Norovirus)", url:"https://www.cdc.gov/norovirus/" },
          { name:"NHS (Diarrhoea & vomiting)", url:"https://www.nhs.uk/conditions/diarrhoea-and-vomiting/" }
        ]
      }
    ];

    /**************************************************
     * Mapping: symptom ‚Üí possible matches (NEW phrasing)
     **************************************************/
    const symptomToDisorders = [
      { keys:["runny nose","congestion","sneezing","sore throat","cough"], may:["Common cold","Seasonal allergies"] },
      { keys:["fever","chills","body aches"], may:["Influenza (flu)","Stomach bug (gastroenteritis)"] },
      { keys:["heartburn","acid reflux"], may:["GERD (acid reflux)"] },
      { keys:["nausea","vomiting","diarrhea","stomach cramps"], may:["Stomach bug (gastroenteritis)","Food intolerance"] },
      { keys:["headache","light sensitivity"], may:["Migraine","Tension headache"] },
      { keys:["burning urination","frequent urination"], may:["Urinary tract infection (UTI)"] },
      { keys:["itchy skin","rash","dry skin","hives"], may:["Skin irritation (eczema/allergy)","Allergic reaction"] },
      { keys:["anxiety","panic","palpitations","insomnia"], may:["Stress / anxiety symptoms"] },
      { keys:["dizziness","dry mouth","dark urine","dehydration"], may:["Dehydration"] }
    ];

    function getPossibleMatches(history){
      const recent = history.slice(-8);
      const bag = recent.map(e => normalizeText(e.symptomName)).join(" | ");
      const found = new Set();

      for (const map of symptomToDisorders){
        const match = map.keys.some(k => bag.includes(normalizeText(k)));
        if (match) map.may.forEach(m => found.add(m));
      }

      const causes = Array.from(found);
      if (causes.length === 0){
        return [
          "You most likely may have something mild and temporary (like a small virus, irritation, or strain).",
          "You most likely may have symptoms related to sleep, stress, hydration, or a recent routine change."
        ];
      }
      return causes.map(c => `You most likely may have ${c}.`);
    }

    function generalSafetyNotes(){
      return [
        "If something feels severe, sudden, or gets worse fast ‚Äî consider getting checked out.",
        "Urgent red flags can include trouble breathing, severe chest pain, fainting, confusion, or one-sided weakness."
      ];
    }

    /**************************************************
     * Foods + liquids suggestions (NEW)
     **************************************************/
    function getFoodAndFluids(symptomName){
      const s = normalizeText(symptomName);
      // default comfort
      const fluids = ["Water", "Warm tea", "Electrolytes (if needed)"];
      const foods = ["Soup/broth", "Rice/toast/crackers", "Banana or applesauce"];

      if (s.includes("sore throat") || s.includes("cough") || s.includes("congestion")){
        return {
          fluids: ["Warm tea (ginger/lemon)", "Warm water", "Honey in tea (if appropriate)", "Water"],
          foods: ["Soup/broth", "Soft foods (oatmeal, yogurt)", "Warm foods (not spicy)"]
        };
      }
      if (s.includes("nausea") || s.includes("vomit") || s.includes("diarrhea") || s.includes("stomach")){
        return {
          fluids: ["Oral rehydration / electrolytes", "Water (small sips)", "Warm ginger tea"],
          foods: ["BRAT-style foods (banana, rice, toast)", "Plain crackers", "Light soup"]
        };
      }
      if (s.includes("headache") || s.includes("migraine")){
        return {
          fluids: ["Water", "Electrolytes (if you haven‚Äôt eaten)", "Caffeine (small amount) if it helps you"],
          foods: ["Light snack (toast, fruit)", "Something salty if dehydrated", "Easy carbs if nauseous"]
        };
      }
      return { fluids, foods };
    }

    /**************************************************
     * UI: history + suggestions + library + disorders
     **************************************************/
    const historyList = document.getElementById("historyList");
    const aiList = document.getElementById("aiList");
    const countPill = document.getElementById("countPill");

    function severityLabel(n){
      n = Number(n);
      if (n <= 3) return { text:"mild", tone:"good" };
      if (n <= 6) return { text:"moderate", tone:"warn" };
      return { text:"severe", tone:"bad" };
    }

    function setLoading(btn, on=true){
      if (!btn) return;
      if (on) btn.classList.add("loading");
      else btn.classList.remove("loading");
    }

    function renderHistory(){
      const history = loadHistory().slice().reverse();
      countPill.textContent = `${history.length} ${history.length === 1 ? "entry" : "entries"}`;
      historyList.innerHTML = "";

      if (history.length === 0){
        historyList.innerHTML = `<div class="item"><div class="meta">No entries yet. Add one above, or use the Library.</div></div>`;
        return;
      }

      for (const entry of history){
        const sev = severityLabel(entry.severity);
        const sevBadge = sev.tone === "good" ? "üü¢" : sev.tone === "warn" ? "üü†" : "üî¥";
        const triggers = (entry.triggers && entry.triggers.length) ? entry.triggers.join(" ‚Ä¢ ") : "‚Äî";

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="top">
            <div>
              <h3>${sevBadge} ${escapeHtml(entry.symptomName)}
                <span class="pill" style="margin-left:8px;">${entry.severity}/10 ‚Ä¢ ${sev.text}</span>
              </h3>
              <div class="meta">
                <b>Duration:</b> ${escapeHtml(entry.duration || "‚Äî")}<br/>
                <b>What happened before:</b> ${escapeHtml(triggers)}<br/>
                <b>Notes:</b> ${escapeHtml(entry.notes || "‚Äî")}<br/>
                <span style="color:var(--muted2)">Saved:</span> ${prettyTime(entry.timestamp)}
              </div>
            </div>
            <div class="row" style="gap:8px; justify-content:flex-end;">
              <button class="btn ghost small" data-action="copy" data-id="${entry.id}">üìã Copy</button>
              <button class="btn danger small" data-action="delete" data-id="${entry.id}">üóëÔ∏è Delete</button>
            </div>
          </div>
          <div class="tiny-disclaimer">This is not real medical advice.</div>
        `;
        historyList.appendChild(el);
      }

      historyList.querySelectorAll("button[data-action]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const action = btn.getAttribute("data-action");
          const id = btn.getAttribute("data-id");
          const raw = loadHistory();
          const idx = raw.findIndex(x => x.id === id);
          if (idx === -1) return;

          setLoading(btn, true);
          await new Promise(r => setTimeout(r, 350));
          setLoading(btn, false);

          if (action === "delete"){
            raw.splice(idx,1);
            saveHistory(raw);
            renderHistory();
            renderSuggestions();
            rebuildCharts();
          } else if (action === "copy"){
            const e = raw[idx];
            const txt = `Symptom: ${e.symptomName}
Severity: ${e.severity}/10
Duration: ${e.duration || ""}
What happened before: ${(e.triggers||[]).join(", ") || ""}
Notes: ${e.notes || ""}
Saved: ${e.timestamp}`;
            try{ await navigator.clipboard.writeText(txt); }catch{}
            alert("Copied.");
          }
        });
      });
    }

    function renderSuggestions(){
      const history = loadHistory();
      aiList.innerHTML = "";

      if (history.length === 0){
        aiList.innerHTML = `<div class="item"><div class="meta">Add a symptom to see helpful suggestions.</div><div class="tiny-disclaimer">This is not real medical advice.</div></div>`;
        return;
      }

      const last = history[history.length - 1];
      const matches = getPossibleMatches(history);
      const food = getFoodAndFluids(last.symptomName);

      const triggersNote = (last.triggers && last.triggers.length)
        ? `You mentioned: <b>${escapeHtml(last.triggers.join(" ‚Ä¢ "))}</b>.`
        : `If you remember what happened before this started (cold exposure, being around someone sick, etc.), add it next time ‚Äî it helps.`;

      const card1 = document.createElement("div");
      card1.className = "item";
      card1.innerHTML = `
        <h3>üß© What this could line up with</h3>
        <div class="meta">
          ${triggersNote}
          <ul style="margin:10px 0 0; padding-left: 18px; line-height:1.55;">
            ${matches.slice(0,6).map(x => `<li>${escapeHtml(x)}</li>`).join("")}
          </ul>
        </div>
        <div class="tiny-disclaimer">This is not real medical advice.</div>
      `;
      aiList.appendChild(card1);

      const card2 = document.createElement("div");
      card2.className = "item";
      card2.innerHTML = `
        <h3>üçµ Foods & liquids to try</h3>
        <div class="meta">
          <b>Liquids:</b> ${escapeHtml(food.fluids.join(", "))}<br/>
          <b>Foods:</b> ${escapeHtml(food.foods.join(", "))}
        </div>
        <div class="tiny-disclaimer">This is not real medical advice.</div>
      `;
      aiList.appendChild(card2);

      const card3 = document.createElement("div");
      card3.className = "item";
      card3.innerHTML = `
        <h3>üö® When to get help</h3>
        <div class="meta">
          <ul style="margin:10px 0 0; padding-left: 18px; line-height:1.55;">
            ${generalSafetyNotes().map(n => `<li>${escapeHtml(n)}</li>`).join("")}
          </ul>
        </div>
        <div class="tiny-disclaimer">This is not real medical advice.</div>
      `;
      aiList.appendChild(card3);
    }

    /**************************************************
     * Library view
     **************************************************/
    const libraryChips = document.getElementById("libraryChips");
    const librarySearch = document.getElementById("librarySearch");
    const libraryAddPanel = document.getElementById("libraryAddPanel");
    let selectedLibrarySymptom = null;

    function renderLibrary(filter=""){
      const q = normalizeText(filter);
      libraryChips.innerHTML = "";
      const list = symptomLibrary.filter(s => normalizeText(s).includes(q)).slice(0, 90);

      if (list.length === 0){
        libraryChips.innerHTML = `<div class="item" style="width:100%;"><div class="meta">No matches. Try a different term.</div></div>`;
        return;
      }

      for (const s of list){
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = s;
        chip.addEventListener("click", () => {
          selectedLibrarySymptom = s;
          renderLibraryAddPanel();
        });
        libraryChips.appendChild(chip);
      }
    }

    function renderLibraryAddPanel(){
      if (!selectedLibrarySymptom){
        libraryAddPanel.innerHTML = `<div class="meta">Select a symptom to begin.</div>`;
        return;
      }

      libraryAddPanel.innerHTML = `
        <div class="top">
          <div>
            <h3>‚ûï Add: ${escapeHtml(selectedLibrarySymptom)}</h3>
            <div class="meta">Choose severity + duration, then save.</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label>Severity (1‚Äì10)</label>
            <select id="libSeverity">
              ${Array.from({length:10},(_,i)=>i+1).map(n => `<option value="${n}" ${n===5?"selected":""}>${n}${n===1?" (very mild)":n===10?" (severe)":""}</option>`).join("")}
            </select>
          </div>
          <div class="field">
            <label>Duration</label>
            <input id="libDuration" placeholder="e.g., 3 days" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field" style="flex: 1 1 100%;">
            <label>Notes</label>
            <textarea id="libNotes" placeholder="Optional context..."></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn" id="libAddBtn">üíæ Save to log</button>
          <button class="btn secondary" id="libFillMainBtn">üìù Fill log form</button>
        </div>

        <div class="tiny-disclaimer">This is not real medical advice.</div>
      `;

      document.getElementById("libAddBtn").addEventListener("click", async () => {
        const btn = document.getElementById("libAddBtn");
        setLoading(btn, true);
        await new Promise(r => setTimeout(r, 350));
        setLoading(btn, false);

        const sev = Number(document.getElementById("libSeverity").value);
        const dur = document.getElementById("libDuration").value.trim();
        const notes = document.getElementById("libNotes").value.trim();
        addEntry(selectedLibrarySymptom, sev, dur, notes);
        alert("Saved.");
      });

      document.getElementById("libFillMainBtn").addEventListener("click", () => {
        document.getElementById("symptomName").value = selectedLibrarySymptom;
        switchTo("logView");
      });
    }

    /**************************************************
     * Disorders view + modal
     **************************************************/
    const disorderCards = document.getElementById("disorderCards");
    const disorderSearch = document.getElementById("disorderSearch");

    const modalBack = document.getElementById("modalBack");
    const closeModalBtn = document.getElementById("closeModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalTags = document.getElementById("modalTags");
    const modalOverview = document.getElementById("modalOverview");
    const modalSymptoms = document.getElementById("modalSymptoms");
    const modalTreatments = document.getElementById("modalTreatments");
    const modalSources = document.getElementById("modalSources");
    const modalQuickAdd = document.getElementById("modalQuickAdd");

    let modalEffChart = null;

    function renderDisorders(filter=""){
      const q = normalizeText(filter);
      const list = disorders.filter(d =>
        normalizeText(d.name).includes(q) ||
        (d.tags||[]).some(t => normalizeText(t).includes(q)) ||
        (d.symptoms||[]).some(s => normalizeText(s).includes(q))
      );

      disorderCards.innerHTML = "";
      if (list.length === 0){
        disorderCards.innerHTML = `<div class="item"><div class="meta">No matches. Try ‚Äúcold‚Äù, ‚ÄúGERD‚Äù, ‚Äúmigraine‚Äù, ‚ÄúUTI‚Äù, etc.</div></div>`;
        return;
      }

      for (const d of list){
        const el = document.createElement("div");
        el.className = "dcard";
        el.innerHTML = `
          <h3>${escapeHtml(d.name)}</h3>
          <p>${escapeHtml(d.overview)}</p>
          <div class="kvs" style="margin-top:10px;">
            ${(d.tags||[]).slice(0,4).map(t => `<span class="kv">${escapeHtml(t)}</span>`).join("")}
          </div>
        `;
        el.addEventListener("click", () => openDisorderModal(d.id));
        disorderCards.appendChild(el);
      }
    }

    function persistSelectedDisorder(id){
      try{
        const obj = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
        obj.selectedDisorderId = id;
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(obj));
      }catch{}
    }
    function getPersistedSelectedDisorder(){
      try{
        const obj = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
        return obj.selectedDisorderId || null;
      }catch{ return null; }
    }
    function updateSelectedDisorderPill(){
      const pill = document.getElementById("selectedDisorderPill");
      const id = getPersistedSelectedDisorder();
      const d = disorders.find(x => x.id === id);
      pill.textContent = d ? `Selected: ${d.name}` : "No condition selected";
    }

    function openDisorderModal(id){
      const d = disorders.find(x => x.id === id);
      if (!d) return;

      modalTitle.textContent = d.name;
      modalTags.innerHTML = (d.tags||[]).map(t => `<span class="kv">${escapeHtml(t)}</span>`).join("");
      modalOverview.textContent = d.overview;
      modalSymptoms.textContent = (d.symptoms||[]).join(", ");

      modalTreatments.innerHTML = "";
      (d.treatments||[]).forEach(t => {
        const li = document.createElement("li");
        li.innerHTML = `<b>${escapeHtml(t.label)}</b> ‚Äî ${escapeHtml(t.note)} <span class="pill" style="margin-left:8px;">${t.score}/5</span>`;
        modalTreatments.appendChild(li);
      });

      modalSources.innerHTML = (d.sources||[]).map(s =>
        `‚Ä¢ <a href="${s.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(s.name)}</a>`
      ).join("<br/>");

      const pick = (d.symptoms || []).slice(0,6);
      modalQuickAdd.innerHTML = `
        <div class="chipbar">
          ${pick.map(s => `<span class="chip" data-sym="${escapeHtml(s)}">${escapeHtml(s)}</span>`).join("")}
        </div>
        <div class="meta" style="margin-top:10px;">Tap a symptom to add it.</div>
        <div class="tiny-disclaimer">This is not real medical advice.</div>
      `;
      modalQuickAdd.querySelectorAll(".chip").forEach(ch => {
        ch.addEventListener("click", () => {
          const sym = ch.getAttribute("data-sym");
          addEntry(sym, 5, "", `Added from condition: ${d.name}`);
          alert("Added.");
        });
      });

      // Chart
      renderEffectivenessChart("modalEffectivenessChart", d.treatments || [], () => {
        if (modalEffChart){ modalEffChart.destroy(); modalEffChart = null; }
      }, (chart) => { modalEffChart = chart; });

      persistSelectedDisorder(d.id);
      updateSelectedDisorderPill();
      rebuildEffectivenessChart();

      modalBack.style.display = "flex";
    }

    function closeModal(){
      modalBack.style.display = "none";
      if (modalEffChart){ modalEffChart.destroy(); modalEffChart = null; }
    }
    closeModalBtn.addEventListener("click", closeModal);
    modalBack.addEventListener("click", (e) => { if (e.target === modalBack) closeModal(); });

    /**************************************************
     * Charts
     **************************************************/
    let severityChart = null;
    let effectivenessChart = null;

    function renderSeverityChart(){
      const history = loadHistory();
      const canvas = document.getElementById("severityChart");
      const sorted = history.slice().sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
      const labels = sorted.map(e => new Date(e.timestamp).toLocaleDateString(undefined,{month:"short", day:"2-digit"}));
      const data = sorted.map(e => Number(e.severity));

      if (severityChart){ severityChart.destroy(); severityChart = null; }

      severityChart = new Chart(canvas, {
        type: "line",
        data: { labels, datasets: [{ label: "Severity (1‚Äì10)", data, tension: 0.35, fill: true }] },
        options: {
          responsive:true,
          plugins:{ legend:{ display:true }, tooltip:{ callbacks:{ label:(ctx)=>`Severity: ${ctx.parsed.y}/10` } } },
          scales:{ y:{ min:0, max:10, ticks:{ stepSize:1 } } }
        }
      });
    }

    function renderEffectivenessChart(canvasId, treatments, beforeDestroy, afterCreate){
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      if (beforeDestroy) beforeDestroy();

      const labels = treatments.map(t => t.label);
      const data = treatments.map(t => Number(t.score));

      const chart = new Chart(canvas, {
        type:"bar",
        data:{ labels, datasets:[{ label:"Effectiveness (1‚Äì5)", data }] },
        options:{
          responsive:true,
          plugins:{ legend:{ display:true }, tooltip:{ callbacks:{ label:(ctx)=>`Rating: ${ctx.parsed.y}/5` } } },
          scales:{ y:{ min:0, max:5, ticks:{ stepSize:1 } } }
        }
      });

      if (afterCreate) afterCreate(chart);
      return chart;
    }

    function rebuildEffectivenessChart(){
      const pill = document.getElementById("selectedDisorderPill");
      const id = getPersistedSelectedDisorder();
      const d = disorders.find(x => x.id === id);
      if (!d){
        if (effectivenessChart){ effectivenessChart.destroy(); effectivenessChart = null; }
        pill.textContent = "No condition selected";
        return;
      }
      renderEffectivenessChart("effectivenessChart", d.treatments || [], () => {
        if (effectivenessChart){ effectivenessChart.destroy(); effectivenessChart = null; }
      }, (chart) => { effectivenessChart = chart; });
    }

    function rebuildCharts(){
      renderSeverityChart();
      rebuildEffectivenessChart();
    }

    /**************************************************
     * Add entry (NOW stores triggers)
     **************************************************/
    function addEntry(symptomName, severity=5, duration="", notes=""){
      const name = String(symptomName || "").trim();
      if (!name){ alert("Please enter a symptom."); return; }

      const entry = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2),
        symptomName: name,
        severity: clamp(Number(severity)||5, 1, 10),
        duration: String(duration||"").trim(),
        notes: String(notes||"").trim(),
        triggers: Array.from(selectedTriggers),
        timestamp: new Date().toISOString()
      };

      const history = loadHistory();
      history.push(entry);
      saveHistory(history);

      // reset triggers after save so each entry feels intentional
      selectedTriggers = new Set();
      renderTriggerChips();

      renderHistory();
      renderSuggestions();
      rebuildCharts();
    }

    /**************************************************
     * Navigation
     **************************************************/
    function switchTo(viewId){
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      document.getElementById(viewId).classList.add("active");

      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(`.tab[data-view="${viewId}"]`).forEach(t => t.classList.add("active"));

      localStorage.setItem(UI_KEY, JSON.stringify({ viewId }));
    }

    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        const v = btn.getAttribute("data-view");
        switchTo(v);
        if (v === "insightsView") rebuildCharts();
      });
    });

    /**************************************************
     * Premium Photo Insights (NEW, $5 unlock demo)
     **************************************************/
    const premiumPill = document.getElementById("premiumPill");
    const premiumLocked = document.getElementById("premiumLocked");
    const premiumUnlocked = document.getElementById("premiumUnlocked");
    const unlockPremiumBtn = document.getElementById("unlockPremiumBtn");
    const photoInput = document.getElementById("photoInput");
    const analyzePhotoBtn = document.getElementById("analyzePhotoBtn");
    const photoResult = document.getElementById("photoResult");

    function isPremium(){
      try{ return localStorage.getItem(PREMIUM_KEY) === "true"; }catch{ return false; }
    }
    function setPremium(on){
      localStorage.setItem(PREMIUM_KEY, on ? "true" : "false");
      renderPremium();
    }
    function renderPremium(){
      if (isPremium()){
        premiumPill.textContent = "‚ú® Premium unlocked";
        premiumLocked.style.display = "none";
        premiumUnlocked.style.display = "block";
      }else{
        premiumPill.textContent = "üîí Premium locked";
        premiumLocked.style.display = "block";
        premiumUnlocked.style.display = "none";
      }
    }

    unlockPremiumBtn.addEventListener("click", async () => {
      setLoading(unlockPremiumBtn, true);
      await new Promise(r => setTimeout(r, 650));
      setLoading(unlockPremiumBtn, false);

      // demo unlock (no payment processing here)
      setPremium(true);
      alert("Premium unlocked (demo).");
    });

    analyzePhotoBtn.addEventListener("click", async () => {
      if (!isPremium()) return;
      if (!photoInput.files || !photoInput.files[0]){
        alert("Please pick an image first.");
        return;
      }

      setLoading(analyzePhotoBtn, true);
      await new Promise(r => setTimeout(r, 700));
      setLoading(analyzePhotoBtn, false);

      // IMPORTANT: This is NOT real medical analysis.
      // This is a placeholder that encourages safer behavior.
      photoResult.innerHTML = `
        <h3>üì∑ Photo notes</h3>
        <div class="meta">
          I can‚Äôt diagnose from a photo ‚Äî but here‚Äôs a safe way to think about it:
          <ul style="margin:10px 0 0; padding-left:18px; line-height:1.55;">
            <li>If it‚Äôs <b>spreading fast</b>, very painful, warm to the touch, or you have fever ‚Äî consider urgent care.</li>
            <li>If it‚Äôs mild, you can track changes (size, color, itching, pain) over 24‚Äì48 hours.</li>
            <li>You most likely may have something like <b>irritation</b>, <b>inflammation</b>, or a <b>minor injury</b> ‚Äî but if you‚Äôre unsure, it‚Äôs worth getting checked.</li>
          </ul>
        </div>
        <div class="tiny-disclaimer">This is not real medical advice.</div>
      `;
    });

    /**************************************************
     * Events
     **************************************************/
    const saveBtn = document.getElementById("saveBtn");

    document.getElementById("symptomForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      setLoading(saveBtn, true);
      await new Promise(r => setTimeout(r, 350));
      setLoading(saveBtn, false);

      const symptomName = document.getElementById("symptomName").value.trim();
      const severity = Number(document.getElementById("severity").value);
      const duration = document.getElementById("duration").value.trim();
      const notes = document.getElementById("notes").value.trim();

      addEntry(symptomName, severity, duration, notes);

      // clear form
      document.getElementById("symptomForm").reset();
      document.getElementById("severity").value = 5;
      selectedTriggers = new Set();
      renderTriggerChips();

      alert("Saved.");
    });

    document.getElementById("refreshAi").addEventListener("click", async (e) => {
      const btn = e.currentTarget;
      setLoading(btn, true);
      await new Promise(r => setTimeout(r, 350));
      setLoading(btn, false);
      renderSuggestions();
    });

    document.getElementById("clearAll").addEventListener("click", () => {
      const ok = confirm("Clear all saved symptom history? This cannot be undone.");
      if (!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
      renderSuggestions();
      rebuildCharts();
    });

    document.getElementById("quickFromLibrary").addEventListener("click", () => {
      switchTo("libraryView");
      setTimeout(() => librarySearch.focus(), 50);
    });

    librarySearch.addEventListener("input", () => renderLibrary(librarySearch.value));
    disorderSearch.addEventListener("input", () => renderDisorders(disorderSearch.value));

    document.getElementById("rebuildCharts").addEventListener("click", rebuildCharts);
    document.getElementById("pickDisorderFromInsights").addEventListener("click", () => {
      switchTo("disordersView");
      setTimeout(() => disorderSearch.focus(), 50);
    });

    /**************************************************
     * Boot
     **************************************************/
    function boot(){
      // restore last view
      try{
        const obj = JSON.parse(localStorage.getItem(UI_KEY) || "{}");
        if (obj.viewId && document.getElementById(obj.viewId)) switchTo(obj.viewId);
      }catch{}

      renderTriggerChips();
      renderHistory();
      renderSuggestions();

      renderLibrary("");
      renderLibraryAddPanel();

      renderDisorders("");
      updateSelectedDisorderPill();

      renderPremium();

      if (document.getElementById("insightsView").classList.contains("active")){
        rebuildCharts();
      }
    }
    boot();
  </script>
</body>
</html>
